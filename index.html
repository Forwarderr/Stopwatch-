<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#faf9f7" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="StudyWatch" />
  <meta name="description" content="Track your study sessions page by page" />
  <title>StudyWatch</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@300;400;500&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cream: #faf9f7;
      --paper: #f4f2ee;
      --warm-white: #ffffff;
      --ink: #1c1917;
      --ink-2: #44403c;
      --ink-3: #78716c;
      --ink-4: #a8a29e;
      --ink-5: #d6d3d1;
      --sage: #4a7c59;
      --sage-light: #d1e8d8;
      --sage-pale: #f0f7f2;
      --amber-w: #b45309;
      --amber-light: #fef3c7;
      --rose-w: #be123c;
      --rose-light: #ffe4e6;
      --blue-w: #1d4ed8;
      --blue-light: #dbeafe;
      --lavender: #7c6fa0;
      --lavender-light: #ede9f6;
      --lavender-pale: #f8f6fd;
      --shadow-sm: 0 1px 3px rgba(28,25,23,0.06), 0 1px 2px rgba(28,25,23,0.04);
      --shadow-md: 0 4px 12px rgba(28,25,23,0.08), 0 2px 4px rgba(28,25,23,0.04);
      --shadow-lg: 0 12px 32px rgba(28,25,23,0.1), 0 4px 8px rgba(28,25,23,0.05);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-lg: 24px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--ink);
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }

    /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      padding: 16px 20px 12px;
      background: var(--warm-white);
      border-bottom: 1px solid var(--ink-5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand-icon {
      width: 32px; height: 32px;
      background: var(--lavender);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
    }
    .brand-name {
      font-family: 'Lora', serif;
      font-weight: 600;
      font-size: 17px;
      color: var(--ink);
      letter-spacing: -0.2px;
    }

    .topbar-actions { display: flex; gap: 8px; }

    .icon-btn {
      width: 36px; height: 36px;
      border-radius: 10px;
      border: 1px solid var(--ink-5);
      background: transparent;
      color: var(--ink-3);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      position: relative;
    }
    .icon-btn:hover { background: var(--paper); color: var(--ink-2); }
    .icon-btn.danger:hover { background: var(--rose-light); color: var(--rose-w); border-color: #fda4af; }
    .icon-btn.hidden { display: none !important; }

    .badge {
      position: absolute; top: -4px; right: -4px;
      width: 16px; height: 16px;
      background: var(--lavender);
      color: white;
      font-size: 9px;
      font-weight: 700;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }

    /* â”€â”€ BOOK SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .book-bar {
      padding: 10px 20px;
      background: var(--warm-white);
      border-bottom: 1px solid var(--ink-5);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .book-select-wrapper {
      flex: 1;
      position: relative;
    }
    .book-select {
      width: 100%;
      appearance: none;
      background: var(--paper);
      border: 1px solid var(--ink-5);
      border-radius: var(--radius-sm);
      padding: 7px 32px 7px 12px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s;
    }
    .book-select:focus { border-color: var(--lavender); }
    .book-select-arrow {
      position: absolute; right: 10px; top: 50%;
      transform: translateY(-50%);
      pointer-events: none; color: var(--ink-4);
    }
    .add-book-btn {
      height: 34px;
      padding: 0 12px;
      border-radius: var(--radius-sm);
      border: 1px dashed var(--lavender);
      background: var(--lavender-pale);
      color: var(--lavender);
      font-size: 12px;
      font-weight: 600;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .add-book-btn:hover { background: var(--lavender-light); }

    /* â”€â”€ TIMER SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .timer-section {
      background: var(--warm-white);
      border-bottom: 1px solid var(--ink-5);
      padding: 20px 20px 16px;
      flex-shrink: 0;
    }

    .display-wrap {
      text-align: center;
      margin-bottom: 16px;
    }
    .timer-display {
      font-family: 'DM Mono', monospace;
      font-size: 52px;
      font-weight: 400;
      color: var(--ink);
      letter-spacing: -2px;
      line-height: 1;
    }
    .timer-display .ms {
      font-size: 24px;
      color: var(--ink-4);
      letter-spacing: 0;
    }
    .timer-label {
      margin-top: 4px;
      font-size: 11px;
      font-weight: 500;
      color: var(--ink-4);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    /* Progress ring */
    .ring-wrap {
      position: relative;
      width: 88px;
      height: 88px;
      margin: 0 auto 12px;
    }
    .ring-svg { transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: var(--ink-5); stroke-width: 3; }
    .ring-fg {
      fill: none;
      stroke: var(--lavender);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-dasharray: 251.2;
      stroke-dashoffset: 251.2;
      transition: stroke-dashoffset 0.5s ease;
    }
    .ring-inner {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .ring-time {
      font-family: 'DM Mono', monospace;
      font-size: 18px;
      font-weight: 400;
      color: var(--ink);
      letter-spacing: -0.5px;
    }
    .ring-ms {
      font-size: 11px;
      color: var(--ink-4);
      font-family: 'DM Mono', monospace;
    }

    /* Controls */
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .ctrl-btn {
      border: none;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-family: 'DM Sans', sans-serif;
    }
    .ctrl-btn:active { transform: scale(0.92); }

    .ctrl-btn.secondary {
      width: 48px; height: 48px;
      border-radius: 14px;
      background: var(--paper);
      color: var(--ink-3);
      border: 1px solid var(--ink-5);
    }
    .ctrl-btn.secondary:hover { background: var(--ink-5); color: var(--ink-2); }

    .ctrl-btn.primary {
      width: 64px; height: 64px;
      border-radius: 20px;
      background: var(--lavender);
      color: white;
      box-shadow: 0 4px 16px rgba(124, 111, 160, 0.35);
    }
    .ctrl-btn.primary:hover { background: #6b5f8f; }
    .ctrl-btn.pause {
      background: var(--amber-w);
      box-shadow: 0 4px 16px rgba(180, 83, 9, 0.3);
    }
    .ctrl-btn.pause:hover { background: #92400e; }
    .ctrl-btn.hidden { display: none !important; }

    @keyframes pulse-ring {
      0% { box-shadow: 0 4px 16px rgba(180,83,9,0.3), 0 0 0 0 rgba(180,83,9,0.25); }
      70% { box-shadow: 0 4px 16px rgba(180,83,9,0.3), 0 0 0 10px rgba(180,83,9,0); }
      100% { box-shadow: 0 4px 16px rgba(180,83,9,0.3), 0 0 0 0 rgba(180,83,9,0); }
    }
    .ctrl-btn.running { animation: pulse-ring 2s infinite; }

    .ctrl-btn.lap {
      width: 48px; height: 48px;
      border-radius: 14px;
      background: var(--sage-pale);
      color: var(--sage);
      border: 1px solid var(--sage-light);
    }
    .ctrl-btn.lap:hover { background: var(--sage-light); }

    /* Save row */
    .save-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .page-input-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      background: var(--paper);
      border: 1.5px solid var(--ink-5);
      border-radius: var(--radius-sm);
      padding: 0 10px;
      transition: border-color 0.15s, box-shadow 0.15s;
      gap: 6px;
    }
    .page-input-wrap:focus-within {
      border-color: var(--lavender);
      box-shadow: 0 0 0 3px rgba(124,111,160,0.1);
    }
    .page-input-wrap svg { color: var(--ink-4); flex-shrink: 0; }
    .page-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink);
      padding: 9px 0;
    }
    .page-input::placeholder { color: var(--ink-4); }

    .save-btn {
      height: 40px;
      padding: 0 16px;
      border-radius: var(--radius-sm);
      border: none;
      background: var(--sage);
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      transition: all 0.15s;
      box-shadow: 0 2px 8px rgba(74,124,89,0.3);
      white-space: nowrap;
    }
    .save-btn:hover { background: #3d6849; }
    .save-btn:active { transform: scale(0.96); }

    /* â”€â”€ ESTIMATE STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .estimate-strip {
      margin: 12px 20px 0;
      background: var(--lavender-pale);
      border: 1px solid var(--lavender-light);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .estimate-icon { color: var(--lavender); flex-shrink: 0; }
    .estimate-input {
      width: 64px;
      background: transparent;
      border: none;
      outline: none;
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      font-weight: 500;
      color: var(--lavender);
      border-bottom: 1.5px dashed var(--lavender);
      text-align: center;
      padding: 2px 4px;
    }
    .estimate-input::placeholder { color: var(--lavender); opacity: 0.5; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"] { -moz-appearance: textfield; }
    .estimate-label { font-size: 12px; color: var(--lavender); font-weight: 500; }
    .estimate-result {
      margin-left: auto;
      text-align: right;
    }
    .estimate-result .finish { font-size: 13px; font-weight: 700; color: var(--lavender); }
    .estimate-result .duration { font-size: 11px; color: var(--ink-4); }
    .estimate-placeholder { font-size: 11px; color: var(--ink-4); font-weight: 500; margin-left: auto; }

    /* â”€â”€ SESSION STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-bar {
      display: flex;
      gap: 1px;
      background: var(--ink-5);
      border-top: 1px solid var(--ink-5);
      flex-shrink: 0;
    }
    .stat-pill {
      flex: 1;
      padding: 8px 12px;
      background: var(--warm-white);
      text-align: center;
    }
    .stat-pill:first-child { border-radius: 0; }
    .stat-num {
      font-family: 'DM Mono', monospace;
      font-size: 15px;
      font-weight: 500;
      color: var(--ink);
      line-height: 1.2;
    }
    .stat-key {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-4);
      font-weight: 600;
    }

    /* â”€â”€ HISTORY LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-wrap {
      flex: 1;
      overflow-y: auto;
      background: var(--cream);
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .history-wrap::-webkit-scrollbar { display: none; }

    /* Tabs */
    .tab-bar {
      display: flex;
      padding: 12px 20px 0;
      gap: 4px;
      background: var(--cream);
      flex-shrink: 0;
      border-bottom: 1px solid var(--ink-5);
      background: var(--warm-white);
    }
    .tab-btn {
      padding: 6px 14px 8px;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--ink-3);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s;
    }
    .tab-btn.active { color: var(--lavender); border-bottom-color: var(--lavender); font-weight: 600; }
    .tab-btn:hover:not(.active) { color: var(--ink-2); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* History items */
    .history-inner {
      padding: 16px 20px 100px;
    }

    .history-date-group { margin-bottom: 16px; }
    .date-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--ink-4);
      margin-bottom: 8px;
    }

    .record-card {
      background: var(--warm-white);
      border: 1px solid var(--ink-5);
      border-radius: var(--radius);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .record-card::before {
      content: '';
      position: absolute; left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--lavender);
      opacity: 0.4;
    }
    .record-card.faster::before { background: var(--sage); opacity: 0.7; }
    .record-card.slower::before { background: var(--rose-w); opacity: 0.5; }
    .record-card.lap-card::before { background: var(--amber-w); opacity: 0.5; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .record-card.new { animation: slideIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards; }

    .record-icon {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; font-size: 16px;
    }
    .record-icon.page { background: var(--lavender-pale); color: var(--lavender); }
    .record-icon.lap-ic { background: var(--amber-light); color: var(--amber-w); }

    .record-main { flex: 1; min-width: 0; }
    .record-title {
      font-size: 13px; font-weight: 600; color: var(--ink);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 140px;
    }
    .record-time {
      font-family: 'DM Mono', monospace;
      font-size: 11px; color: var(--ink-3); margin-top: 1px;
    }

    .record-right { text-align: right; flex-shrink: 0; }
    .record-bigtime {
      font-family: 'DM Mono', monospace;
      font-size: 15px; font-weight: 500; color: var(--ink);
    }
    .record-badge {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 7px; border-radius: 6px;
      font-size: 10px; font-weight: 700; margin-top: 3px;
    }
    .record-badge.faster { background: var(--sage-pale); color: var(--sage); }
    .record-badge.slower { background: var(--rose-light); color: var(--rose-w); }
    .record-badge.baseline { background: var(--paper); color: var(--ink-3); }
    .record-badge.same { background: var(--blue-light); color: var(--blue-w); }

    .record-delete {
      position: absolute; right: 8px; top: 8px;
      width: 28px; height: 28px;
      border-radius: 6px;
      background: transparent;
      border: none;
      color: var(--ink-5);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      opacity: 0;
    }
    /* Show on hover for desktop */
    .record-card:hover .record-delete { opacity: 1; }
    .record-delete:hover { background: var(--rose-light); color: var(--rose-w); }
    /* Always visible on touch devices */
    @media (hover: none) {
      .record-delete { opacity: 0.35; }
      .record-delete:active { background: var(--rose-light); color: var(--rose-w); opacity: 1; }
    }

    /* Laps section */
    .lap-section { margin-top: 4px; border-top: 1px dashed var(--ink-5); padding-top: 8px; }
    .lap-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 0;
    }
    .lap-name { font-size: 11px; color: var(--ink-3); font-weight: 500; }
    .lap-time { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--ink-2); }

    /* â”€â”€ ANALYTICS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-area {
      padding: 16px 20px;
    }
    .chart-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.7px; color: var(--ink-3); margin-bottom: 12px;
    }
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 80px;
    }
    .bar-wrap {
      flex: 1;
      display: flex; flex-direction: column;
      align-items: center; gap: 4px;
    }
    .bar {
      width: 100%;
      border-radius: 4px 4px 0 0;
      background: var(--lavender);
      opacity: 0.7;
      min-height: 4px;
      transition: height 0.5s cubic-bezier(0.16,1,0.3,1);
      position: relative;
    }
    .bar.fastest { opacity: 1; background: var(--sage); }
    .bar.slowest { opacity: 1; background: var(--rose-w); }
    .bar-label { font-size: 9px; color: var(--ink-4); text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

    .analytics-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 8px; margin-bottom: 12px;
    }
    .analytics-card {
      background: var(--warm-white);
      border: 1px solid var(--ink-5);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .analytics-num { font-family: 'DM Mono', monospace; font-size: 20px; font-weight: 400; color: var(--ink); }
    .analytics-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--ink-4); font-weight: 600; margin-top: 2px; }

    /* Streak */
    .streak-area {
      margin: 0 20px 12px;
      background: linear-gradient(135deg, var(--lavender-pale), #f5f0fd);
      border: 1px solid var(--lavender-light);
      border-radius: var(--radius);
      padding: 14px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .streak-num { font-family: 'Lora', serif; font-size: 36px; font-weight: 600; color: var(--lavender); line-height: 1; }
    .streak-info {}
    .streak-title { font-size: 14px; font-weight: 600; color: var(--ink); }
    .streak-sub { font-size: 11px; color: var(--ink-3); }

    /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 60px 20px;
      text-align: center;
      gap: 8px;
    }
    .empty-icon { font-size: 40px; margin-bottom: 4px; opacity: 0.5; }
    .empty-title { font-size: 15px; font-weight: 600; color: var(--ink-3); }
    .empty-sub { font-size: 13px; color: var(--ink-4); }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(28,25,23,0.4);
      backdrop-filter: blur(4px);
      display: flex; align-items: flex-end; justify-content: center;
      z-index: 100;
      opacity: 0; pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--warm-white);
      border-radius: 24px 24px 0 0;
      padding: 24px 24px 40px;
      width: 100%;
      max-width: 480px;
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-handle {
      width: 36px; height: 4px;
      background: var(--ink-5);
      border-radius: 2px;
      margin: 0 auto 20px;
    }
    .modal-title { font-family: 'Lora', serif; font-size: 20px; font-weight: 600; color: var(--ink); margin-bottom: 16px; }

    .form-field { margin-bottom: 14px; }
    .form-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--ink-3); margin-bottom: 6px; display: block; }
    .form-input {
      width: 100%;
      background: var(--paper);
      border: 1.5px solid var(--ink-5);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--ink);
      outline: none;
      transition: border-color 0.15s;
    }
    .form-input:focus { border-color: var(--lavender); }

    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .modal-btn {
      flex: 1; padding: 12px;
      border: none; border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
    }
    .modal-btn.cancel { background: var(--paper); color: var(--ink-3); }
    .modal-btn.confirm { background: var(--lavender); color: white; }
    .modal-btn.confirm:hover { background: #6b5f8f; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast-container {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      display: flex; flex-direction: column; gap: 8px;
      pointer-events: none;
    }
    .toast {
      background: var(--ink);
      color: white;
      padding: 10px 18px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.3s cubic-bezier(0.16,1,0.3,1) forwards, toastOut 0.3s ease 2.5s forwards;
      white-space: nowrap;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(8px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; pointer-events: none; }
    }

    /* â”€â”€ CELEBRATION MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .celebrate-overlay {
      position: fixed; inset: 0;
      background: rgba(28,25,23,0.5);
      backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      z-index: 300;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .celebrate-overlay.open { opacity: 1; pointer-events: all; }

    .celebrate-box {
      background: var(--warm-white);
      border-radius: 28px;
      padding: 36px 28px 28px;
      width: calc(100% - 48px);
      max-width: 340px;
      text-align: center;
      transform: scale(0.85) translateY(20px);
      transition: transform 0.35s cubic-bezier(0.16,1,0.3,1);
      box-shadow: var(--shadow-lg);
    }
    .celebrate-overlay.open .celebrate-box { transform: scale(1) translateY(0); }

    .celebrate-emoji {
      font-size: 64px;
      line-height: 1;
      margin-bottom: 16px;
      display: block;
      animation: celebBounce 0.6s cubic-bezier(0.34,1.56,0.64,1) 0.1s both;
    }
    @keyframes celebBounce {
      from { transform: scale(0.3) rotate(-15deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .celebrate-title {
      font-family: 'Lora', serif;
      font-size: 22px; font-weight: 600;
      color: var(--ink); margin-bottom: 8px;
    }
    .celebrate-msg {
      font-size: 14px; color: var(--ink-3);
      line-height: 1.5; margin-bottom: 24px;
    }
    .celebrate-close {
      width: 100%; padding: 13px;
      background: var(--lavender); color: white;
      border: none; border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
    }
    .celebrate-close:hover { background: #6b5f8f; }

    /* confetti burst */
    .confetti-wrap {
      position: fixed; inset: 0;
      pointer-events: none; z-index: 299; overflow: hidden;
    }
    .confetti-piece {
      position: absolute;
      width: 8px; height: 8px;
      border-radius: 2px;
      animation: confettiFall linear forwards;
    }
    @keyframes confettiFall {
      0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* pace toast â€” slightly bigger than regular toast */
    .toast.pace {
      font-size: 14px;
      padding: 12px 20px;
      border-radius: 16px;
      max-width: 280px;
      text-align: center;
      white-space: normal;
      line-height: 1.4;
    }
    .toast.pace.great { background: var(--sage); }
    .toast.pace.focus { background: #9f1239; }
    .install-banner {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--warm-white);
      border-top: 1px solid var(--ink-5);
      padding: 16px 20px;
      display: flex; align-items: center; gap: 12px;
      z-index: 90;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
      box-shadow: 0 -4px 20px rgba(28,25,23,0.08);
    }
    .install-banner.show { transform: translateY(0); }
    .install-icon { font-size: 28px; }
    .install-text { flex: 1; }
    .install-text strong { font-size: 14px; display: block; }
    .install-text span { font-size: 12px; color: var(--ink-3); }
    .install-btn {
      padding: 8px 16px;
      background: var(--lavender);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .install-dismiss {
      width: 28px; height: 28px;
      border: none; background: transparent;
      color: var(--ink-4); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      border-radius: 6px;
    }
    .install-dismiss:hover { background: var(--paper); }

    /* â”€â”€ GOAL INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .goal-bar-wrap {
      padding: 0 20px 10px;
      background: var(--warm-white);
    }
    .goal-label-row {
      display: flex; justify-content: space-between; margin-bottom: 5px;
    }
    .goal-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ink-4); }
    .goal-pages { font-size: 10px; font-weight: 600; color: var(--lavender); }
    .goal-bar-bg {
      height: 4px; background: var(--ink-5); border-radius: 2px; overflow: hidden;
    }
    .goal-bar-fg {
      height: 100%; background: linear-gradient(90deg, var(--lavender), var(--sage));
      border-radius: 2px;
      transition: width 0.5s cubic-bezier(0.16,1,0.3,1);
    }
    .goal-bar-wrap.hidden { display: none !important; }

    /* â”€â”€ COMPACT MODE (ring view) â”€â”€â”€â”€â”€â”€â”€ */
    .view-toggle {
      display: flex;
      border: 1px solid var(--ink-5);
      border-radius: 8px;
      overflow: hidden;
    }
    .view-toggle-btn {
      flex: 1; padding: 5px 8px;
      border: none; background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 11px; font-weight: 500;
      color: var(--ink-3); cursor: pointer;
      transition: all 0.15s;
    }
    .view-toggle-btn.active { background: var(--lavender); color: white; }

    #ringView { display: none; }
    .show-ring #ringView { display: block; }
    .show-ring #flatView { display: none; }
  </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">
    <div class="brand-icon">ðŸ“–</div>
    <span class="brand-name">StudyWatch</span>
  </div>
  <div class="topbar-actions">
    <div class="view-toggle">
      <button class="view-toggle-btn active" id="flatModeBtn" title="Standard view">â–¬</button>
      <button class="view-toggle-btn" id="ringModeBtn" title="Ring view">â—Ž</button>
    </div>
    <button class="icon-btn" id="statsBtn" title="Analytics">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
    </button>
    <button class="icon-btn" id="settingsBtn" title="Settings">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    </button>
    <button class="icon-btn danger hidden" id="clearBtn" title="Clear all">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2M19 6l-1 14H6L5 6"/></svg>
    </button>
  </div>
</div>

<!-- BOOK BAR -->
<div class="book-bar">
  <div class="book-select-wrapper">
    <select class="book-select" id="bookSelect">
      <option value="default">ðŸ“š General Study</option>
    </select>
    <svg class="book-select-arrow" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
  </div>
  <button class="add-book-btn" id="addBookBtn">+ Book</button>
</div>

<!-- TIMER SECTION -->
<div class="timer-section" id="timerSection">

  <!-- FLAT VIEW -->
  <div id="flatView">
    <div class="display-wrap">
      <div class="timer-display" id="display">00:00:00<span class="ms">.00</span></div>
      <div class="timer-label" id="timerLabel">Ready to study</div>
    </div>
  </div>

  <!-- RING VIEW -->
  <div id="ringView">
    <div class="ring-wrap">
      <svg class="ring-svg" width="88" height="88" viewBox="0 0 88 88">
        <circle class="ring-bg" cx="44" cy="44" r="40"/>
        <circle class="ring-fg" id="ringFg" cx="44" cy="44" r="40"/>
      </svg>
      <div class="ring-inner">
        <div class="ring-time" id="ringTime">00:00</div>
        <div class="ring-ms" id="ringMs">.00</div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="ctrl-btn secondary" id="resetBtn" title="Reset">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M3 12a9 9 0 109-9M3 3v6h6"/></svg>
    </button>
    <button class="ctrl-btn primary" id="startBtn" title="Start">
      <svg width="26" height="26" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>
    <button class="ctrl-btn primary pause hidden running" id="pauseBtn" title="Pause">
      <svg width="26" height="26" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>
    <button class="ctrl-btn lap" id="lapBtn" title="Lap">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
    </button>
  </div>

  <div class="save-row">
    <div class="page-input-wrap">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
      <input type="text" class="page-input" id="pageInput" maxlength="40" placeholder="Page / section nameâ€¦" autocomplete="off" />
    </div>
    <button class="save-btn" id="saveBtn">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
      Save
    </button>
  </div>

  <div class="estimate-strip" id="estimateStrip">
    <svg class="estimate-icon" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
    <input type="number" class="estimate-input" id="pagesLeftInput" min="1" max="9999" inputmode="numeric" placeholder="â€”" />
    <span class="estimate-label">pages left</span>
    <div class="estimate-result hidden" id="estimateResult">
      <div class="finish" id="finishTime">â€”</div>
      <div class="duration" id="finishDuration">â€”</div>
    </div>
    <div class="estimate-placeholder" id="estimatePlaceholder">Enter pages to estimate</div>
  </div>
</div>

<!-- GOAL BAR -->
<div class="goal-bar-wrap hidden" id="goalBarWrap">
  <div class="goal-label-row">
    <span class="goal-label">Daily Goal</span>
    <span class="goal-pages" id="goalPages">0 / 0 pages</span>
  </div>
  <div class="goal-bar-bg">
    <div class="goal-bar-fg" id="goalBarFg" style="width:0%"></div>
  </div>
</div>

<!-- STATS BAR -->
<div class="stats-bar" id="statsBar">
  <div class="stat-pill">
    <div class="stat-num" id="statPages">0</div>
    <div class="stat-key">Pages</div>
  </div>
  <div class="stat-pill">
    <div class="stat-num" id="statTotal">â€”</div>
    <div class="stat-key">Total</div>
  </div>
  <div class="stat-pill">
    <div class="stat-num" id="statAvg">â€”</div>
    <div class="stat-key">Avg/pg</div>
  </div>
  <div class="stat-pill">
    <div class="stat-num" id="statBest">â€”</div>
    <div class="stat-key">Best</div>
  </div>
</div>

<!-- TAB BAR -->
<div class="tab-bar">
  <button class="tab-btn active" data-tab="history">History</button>
  <button class="tab-btn" data-tab="analytics">Analytics</button>
</div>

<!-- HISTORY -->
<div class="history-wrap">

  <div class="tab-content active" id="tab-history">
    <div class="history-inner" id="historyInner">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">ðŸ“–</div>
        <div class="empty-title">No pages tracked yet</div>
        <div class="empty-sub">Start the timer and save your first page</div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="tab-analytics">
    <div class="chart-area">

      <div class="streak-area" id="streakArea" style="display:none">
        <div class="streak-num" id="streakNum">0</div>
        <div class="streak-info">
          <div class="streak-title">Day Study Streak ðŸ”¥</div>
          <div class="streak-sub" id="streakSub">Keep it going!</div>
        </div>
      </div>

      <div class="analytics-grid" id="analyticsGrid"></div>

      <div class="chart-title">Time per page (recent 10)</div>
      <div class="bar-chart" id="barChart">
        <div class="empty-state" style="padding:10px;width:100%">
          <div class="empty-title" style="font-size:12px">No data yet</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- CONFIRM MODAL (replaces native browser confirm()) -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" style="font-size:17px" id="confirmMsg">Are you sure?</div>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="confirmNo">Cancel</button>
      <button class="modal-btn confirm" id="confirmYes" style="background:var(--rose-w)">Delete</button>
    </div>
  </div>
</div>

<!-- CELEBRATION MODAL -->
<div class="celebrate-overlay" id="celebrateOverlay">
  <div class="celebrate-box">
    <span class="celebrate-emoji" id="celebEmoji">ðŸŽ‰</span>
    <div class="celebrate-title" id="celebTitle">Well done!</div>
    <div class="celebrate-msg" id="celebMsg">You're on a roll!</div>
    <button class="celebrate-close" id="celebClose">Keep going! ðŸ’ª</button>
  </div>
</div>
<div class="confetti-wrap" id="confettiWrap"></div>

<!-- INSTALL BANNER -->
<div class="install-banner" id="installBanner">
  <div class="install-icon">ðŸ“²</div>
  <div class="install-text">
    <strong>Add to Home Screen</strong>
    <span>Install StudyWatch as an app</span>
  </div>
  <button class="install-btn" id="installBtn">Install</button>
  <button class="install-dismiss" id="installDismiss">âœ•</button>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<!-- ADD BOOK MODAL -->
<div class="modal-overlay" id="addBookModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add New Book</div>
    <div class="form-field">
      <label class="form-label">Book / Subject Title</label>
      <input type="text" class="form-input" id="newBookTitle" placeholder="e.g. Chemistry Chapter 5" maxlength="50" />
    </div>
    <div class="form-field">
      <label class="form-label">Daily Page Goal (optional)</label>
      <input type="number" class="form-input" id="newBookGoal" placeholder="e.g. 20" min="1" max="500" />
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="cancelAddBook">Cancel</button>
      <button class="modal-btn confirm" id="confirmAddBook">Add Book</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>
    <div class="form-field">
      <label class="form-label">Student Name</label>
      <input type="text" class="form-input" id="settingName" placeholder="Your name" maxlength="30" />
    </div>
    <div class="form-field">
      <label class="form-label">Default Goal (pages/day)</label>
      <input type="number" class="form-input" id="settingGoal" placeholder="e.g. 30" min="1" max="1000" />
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="cancelSettings">Cancel</button>
      <button class="modal-btn confirm" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  running: false,
  startTime: 0,
  elapsed: 0,
  interval: null,
  laps: [],
  currentBook: 'default',
  viewMode: 'flat',
};

// â”€â”€ PERSISTENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function load(key, fallback) {
  try {
    const v = localStorage.getItem(key);
    if (v === null) return fallback;
    return JSON.parse(v);
  } catch (e) {
    // Corrupt data â€” remove it so it doesn't keep failing
    try { localStorage.removeItem(key); } catch {}
    return fallback;
  }
}

function save(key, val) {
  try {
    localStorage.setItem(key, JSON.stringify(val));
    return true;
  } catch (e) {
    // Storage full or unavailable
    if (e && e.name === 'QuotaExceededError') {
      showStorageWarning();
    }
    return false;
  }
}

let storageWarnShown = false;
function showStorageWarning() {
  if (storageWarnShown) return;
  storageWarnShown = true;
  toast('âš ï¸ Storage full â€” old records may not save. Clear history to free space.');
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDefaultBooks() {
  return { default: { title: 'General Study', goal: 0, records: [] } };
}

let books = load('sw_books', null);
// Validate books structure
if (!books || typeof books !== 'object' || Array.isArray(books)) {
  books = getDefaultBooks();
} else {
  // Ensure every book has required fields and records is an array
  Object.keys(books).forEach(id => {
    if (!books[id] || typeof books[id] !== 'object') {
      delete books[id];
      return;
    }
    if (!Array.isArray(books[id].records)) books[id].records = [];
    if (!books[id].title) books[id].title = 'Untitled';
    if (typeof books[id].goal !== 'number') books[id].goal = 0;
    // Validate each record
    books[id].records = books[id].records.filter(r =>
      r && typeof r === 'object' &&
      typeof r.ms === 'number' && r.ms >= 0 &&
      typeof r.ts === 'number' && r.ts > 0 &&
      typeof r.page === 'string'
    );
  });
  // Always ensure default book exists
  if (!books.default) books.default = { title: 'General Study', goal: 0, records: [] };
}

let settings = load('sw_settings', { name: '', goal: 0 });
if (!settings || typeof settings !== 'object') settings = { name: '', goal: 0 };
if (typeof settings.goal !== 'number') settings.goal = 0;

let pagesLeftVal = load('sw_pagesLeft', '');

// â”€â”€ DOM REFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $display      = document.getElementById('display');
const $ringTime     = document.getElementById('ringTime');
const $ringMs       = document.getElementById('ringMs');
const $ringFg       = document.getElementById('ringFg');
const $timerLabel   = document.getElementById('timerLabel');
const $startBtn     = document.getElementById('startBtn');
const $pauseBtn     = document.getElementById('pauseBtn');
const $resetBtn     = document.getElementById('resetBtn');
const $lapBtn       = document.getElementById('lapBtn');
const $saveBtn      = document.getElementById('saveBtn');
const $pageInput    = document.getElementById('pageInput');
const $pagesLeft    = document.getElementById('pagesLeftInput');
const $estimateResult  = document.getElementById('estimateResult');
const $estimatePh   = document.getElementById('estimatePlaceholder');
const $finishTime   = document.getElementById('finishTime');
const $finishDur    = document.getElementById('finishDuration');
const $historyInner = document.getElementById('historyInner');
const $emptyState   = document.getElementById('emptyState');
const $clearBtn     = document.getElementById('clearBtn');
const $bookSelect   = document.getElementById('bookSelect');
const $statPages    = document.getElementById('statPages');
const $statTotal    = document.getElementById('statTotal');
const $statAvg      = document.getElementById('statAvg');
const $statBest     = document.getElementById('statBest');
const $goalBarWrap  = document.getElementById('goalBarWrap');
const $goalPages    = document.getElementById('goalPages');
const $goalBarFg    = document.getElementById('goalBarFg');
const $toastContainer = document.getElementById('toastContainer');
const $flatView     = document.getElementById('flatView');
const $ringView     = document.getElementById('ringView');
const $timerSection = document.getElementById('timerSection');
const $flatModeBtn  = document.getElementById('flatModeBtn');
const $ringModeBtn  = document.getElementById('ringModeBtn');
const $streakArea   = document.getElementById('streakArea');
const $streakNum    = document.getElementById('streakNum');
const $streakSub    = document.getElementById('streakSub');
const $analyticsGrid = document.getElementById('analyticsGrid');
const $barChart     = document.getElementById('barChart');
const $celebOverlay = document.getElementById('celebrateOverlay');
const $celebEmoji   = document.getElementById('celebEmoji');
const $celebTitle   = document.getElementById('celebTitle');
const $celebMsg     = document.getElementById('celebMsg');
const $celebClose   = document.getElementById('celebClose');
const $confettiWrap = document.getElementById('confettiWrap');
const $installBanner = document.getElementById('installBanner');
const $installBtn   = document.getElementById('installBtn');
const $installDismiss = document.getElementById('installDismiss');

// â”€â”€ FORMAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(ms) {
  const totalMs = Math.max(0, ms); // guard negative
  const s = Math.floor(totalMs / 1000);
  const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
  const cs = Math.floor((totalMs % 1000) / 10);
  const p = n => String(n).padStart(2, '0');
  return { h: p(h), m: p(m), s: p(sec), cs: p(cs) };
}
function fmtShort(ms) {
  const { h, m, s } = fmt(ms);
  return h !== '00' ? `${h}:${m}:${s}` : `${m}:${s}`;
}
function fmtFull(ms) {
  const { h, m, s } = fmt(ms);
  return `${h}:${m}:${s}`;
}
function fmtDuration(ms) {
  const totalSec = Math.floor(Math.max(0, ms) / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h > 0) return `${h}h ${m}m`;
  if (m > 0) return `${m}m`;
  return `${s}s`;
}
function fmtStat(ms) {
  const totalSec = Math.floor(Math.max(0, ms) / 1000);
  const m = Math.floor(totalSec / 60), s = totalSec % 60;
  if (m >= 60) return `${Math.floor(m / 60)}h${String(m % 60).padStart(2,'0')}m`;
  if (m > 0) return `${m}m${String(s).padStart(2,'0')}s`;
  return `${s}s`;
}

// â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick() {
  state.elapsed = Date.now() - state.startTime;
  updateDisplay();
}

function updateDisplay() {
  const { h, m, s, cs } = fmt(state.elapsed);
  $display.innerHTML = `${h}:${m}:${s}<span class="ms">.${cs}</span>`;
  $ringTime.textContent = `${m}:${s}`;
  $ringMs.textContent = `.${cs}`;
  // Ring progress: 0â€“5 min maps to full circle
  const pct = Math.min(state.elapsed / 300000, 1);
  $ringFg.style.strokeDashoffset = 251.2 * (1 - pct);
}

function startTimer() {
  if (state.running) return;
  state.running = true;
  state.startTime = Date.now() - state.elapsed;
  state.interval = setInterval(tick, 33);
  $startBtn.classList.add('hidden');
  $pauseBtn.classList.remove('hidden');
  $timerLabel.textContent = 'Studyingâ€¦';
}

function pauseTimer() {
  if (!state.running) return;
  state.running = false;
  clearInterval(state.interval);
  state.interval = null;
  $pauseBtn.classList.add('hidden');
  $startBtn.classList.remove('hidden');
  $timerLabel.textContent = 'Paused';
}

function resetTimer() {
  pauseTimer();
  state.elapsed = 0;
  state.laps = [];
  updateDisplay();
  $timerLabel.textContent = 'Ready to study';
}

function lap() {
  if (!state.running && state.elapsed === 0) return;
  if (state.elapsed < 500) return; // ignore accidental taps
  const prev = state.laps.reduce((a, l) => a + l.ms, 0);
  const splitMs = state.elapsed - prev;
  if (splitMs < 500) return; // ignore double-taps
  state.laps.push({ ms: splitMs, total: state.elapsed, label: `Lap ${state.laps.length + 1}` });
  toast(`Lap ${state.laps.length}: ${fmtShort(splitMs)}`);
}

// â”€â”€ BOOKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCurrentBook() {
  // Always fall back to default if current book was deleted or is invalid
  if (!books[state.currentBook]) {
    state.currentBook = 'default';
    if (!books.default) books.default = { title: 'General Study', goal: 0, records: [] };
  }
  return books[state.currentBook];
}

function getRecords() {
  const b = getCurrentBook();
  if (!Array.isArray(b.records)) b.records = [];
  return b.records;
}

function saveBooks() {
  return save('sw_books', books);
}

function renderBookSelect() {
  const cur = state.currentBook;
  try {
    $bookSelect.innerHTML = Object.entries(books).map(([id, b]) =>
      `<option value="${id.replace(/"/g, '&quot;')}" ${id === cur ? 'selected' : ''}>${
        (b.title || 'Untitled').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      }</option>`
    ).join('');
  } catch (e) {
    $bookSelect.innerHTML = '<option value="default">ðŸ“š General Study</option>';
  }
}

// â”€â”€ SAVE RECORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveRecord() {
  if (state.elapsed < 1000) {
    toast('Track at least 1 second first â±');
    return;
  }

  $pageInput.blur();

  const rawName = ($pageInput.value || '').trim();
  // Sanitise: strip HTML, limit length
  const safeName = rawName
    .replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .slice(0, 40)
    || `Entry ${getRecords().length + 1}`;

  const ms = Math.round(state.elapsed); // integer ms, no floating point

  // Comparison against last record
  let comparison = null;
  const recs = getRecords();
  if (recs.length > 0) {
    const lastMs = recs[recs.length - 1].ms;
    if (typeof lastMs === 'number' && lastMs > 0) {
      const diff = ms - lastMs;
      const pct = ((Math.abs(diff) / lastMs) * 100).toFixed(1);
      comparison = { diff, pct, faster: diff < 0, slower: diff > 0 };
    }
  }

  const record = {
    id: Date.now(),
    page: safeName,
    ms,
    ts: Date.now(),
    comparison,
    laps: state.laps.map(l => ({ ...l })), // shallow copy
  };

  // Capture today count BEFORE adding new record for reward threshold check
  const prevDoneCount = todayPages();

  getCurrentBook().records.push(record);
  const saved = saveBooks();
  if (!saved) {
    // Storage failed â€” remove the record we just added
    getCurrentBook().records.pop();
    return;
  }

  // Auto-increment page number in input
  const numMatch = rawName.match(/(\d+)(?!.*\d)/);
  if (numMatch) {
    $pageInput.value = rawName.replace(/(\d+)(?!.*\d)/, n => String(parseInt(n, 10) + 1));
  } else if (rawName) {
    $pageInput.value = '';
  }

  // Decrement pages left
  const pl = parseInt($pagesLeft.value, 10);
  if (!isNaN(pl) && pl > 0) {
    $pagesLeft.value = pl - 1;
    save('sw_pagesLeft', pl - 1);
  }

  resetTimer();
  renderHistory(true);
  updateStats();
  updateGoalBar();
  updateEstimate();
  renderAnalytics();

  // Pace feedback toast (no save toast â€” removed per request)
  checkPaceToast(comparison);

  // Reward check â€” must happen after updateGoalBar/updateEstimate
  checkRewards(prevDoneCount);
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function groupByDate(records) {
  const groups = {};
  [...records].reverse().forEach(r => {
    try {
      const d = new Date(r.ts);
      const key = isNaN(d.getTime())
        ? 'Unknown date'
        : d.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
      if (!groups[key]) groups[key] = [];
      groups[key].push(r);
    } catch {}
  });
  return groups;
}

function renderHistory(animateFirst = false) {
  const recs = getRecords();
  $clearBtn.classList.toggle('hidden', recs.length === 0);

  // Always clear and rebuild
  $historyInner.innerHTML = '';

  if (recs.length === 0) {
    // Re-append the empty state (it was cleared above)
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.innerHTML = `
      <div class="empty-icon">ðŸ“–</div>
      <div class="empty-title">No pages tracked yet</div>
      <div class="empty-sub">Start the timer and save your first page</div>`;
    $historyInner.appendChild(empty);
    return;
  }

  const groups = groupByDate(recs);

  Object.entries(groups).forEach(([date, records], gi) => {
    const grp = document.createElement('div');
    grp.className = 'history-date-group';

    const dateEl = document.createElement('div');
    dateEl.className = 'date-label';
    dateEl.textContent = date;
    grp.appendChild(dateEl);

    records.forEach((r, i) => {
      const comp = r.comparison;
      const card = document.createElement('div');
      let cardClass = 'record-card';
      if (comp) {
        if (comp.faster) cardClass += ' faster';
        else if (comp.slower) cardClass += ' slower';
      }
      if (animateFirst && gi === 0 && i === 0) cardClass += ' new';
      card.className = cardClass;

      // Badge
      let badge = '';
      if (!comp) {
        badge = `<span class="record-badge baseline">Baseline</span>`;
      } else if (comp.faster) {
        badge = `<span class="record-badge faster">â–¼ ${comp.pct}% faster</span>`;
      } else if (comp.slower) {
        badge = `<span class="record-badge slower">â–² ${comp.pct}% slower</span>`;
      } else {
        badge = `<span class="record-badge same">Same pace</span>`;
      }

      // Timestamp
      let timeStr = '';
      try {
        const d = new Date(r.ts);
        timeStr = isNaN(d.getTime()) ? '' : d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch {}

      // Laps HTML
      let lapsHtml = '';
      if (Array.isArray(r.laps) && r.laps.length > 0) {
        lapsHtml = `<div class="lap-section">${
          r.laps.map(l => `<div class="lap-row">
            <span class="lap-name">${(l.label || 'Lap').replace(/</g,'&lt;')}</span>
            <span class="lap-time">${fmtShort(l.ms || 0)}</span>
          </div>`).join('')
        }</div>`;
      }

      card.innerHTML = `
        <div class="record-icon page">ðŸ“„</div>
        <div class="record-main">
          <div class="record-title" title="${r.page}">${r.page}</div>
          ${timeStr ? `<div class="record-time">${timeStr}</div>` : ''}
          ${lapsHtml}
        </div>
        <div class="record-right">
          <div class="record-bigtime">${fmtFull(r.ms)}</div>
          ${badge}
        </div>
        <button class="record-delete" aria-label="Delete record">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>`;

      // Wire delete button â€” using closure over r.id
      const delBtn = card.querySelector('.record-delete');
      delBtn.addEventListener('click', e => {
        e.stopPropagation();
        deleteRecord(r.id);
      });
      // Also handle touch (for mobile where hover doesn't work)
      delBtn.addEventListener('touchstart', e => {
        e.stopPropagation();
        delBtn.style.opacity = '1';
      }, { passive: true });

      grp.appendChild(card);
    });

    $historyInner.appendChild(grp);
  });
}

function deleteRecord(id) {
  if (typeof id !== 'number') return;
  const before = getRecords().length;
  getCurrentBook().records = getRecords().filter(r => r.id !== id);
  if (getRecords().length === before) return; // nothing deleted
  saveBooks();
  renderHistory();
  updateStats();
  updateGoalBar();
  updateEstimate(); // â† fix: reset estimate area after delete
  renderAnalytics();
}

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const recs = getRecords();
  if (!recs.length) {
    $statPages.textContent = '0';
    $statTotal.textContent = 'â€”';
    $statAvg.textContent = 'â€”';
    $statBest.textContent = 'â€”';
    return;
  }
  try {
    const total = recs.reduce((a, r) => a + (r.ms || 0), 0);
    const avg = total / recs.length;
    const best = Math.min(...recs.map(r => r.ms || Infinity));
    $statPages.textContent = recs.length;
    $statTotal.textContent = fmtStat(total);
    $statAvg.textContent = fmtStat(avg);
    $statBest.textContent = best === Infinity ? 'â€”' : fmtStat(best);
  } catch (e) {
    $statPages.textContent = recs.length;
    $statTotal.textContent = 'â€”';
    $statAvg.textContent = 'â€”';
    $statBest.textContent = 'â€”';
  }
}

// â”€â”€ GOAL BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayPages() {
  const today = new Date().toDateString();
  return getRecords().filter(r => {
    try { return new Date(r.ts).toDateString() === today; }
    catch { return false; }
  }).length;
}

function updateGoalBar() {
  try {
    const book = getCurrentBook();
    const goal = (typeof book.goal === 'number' ? book.goal : 0) || (typeof settings.goal === 'number' ? settings.goal : 0);
    if (!goal || goal <= 0) {
      $goalBarWrap.classList.add('hidden');
      return;
    }
    $goalBarWrap.classList.remove('hidden');
    const done = todayPages();
    const pct = Math.min((done / goal) * 100, 100);
    $goalBarFg.style.width = pct + '%';
    $goalPages.textContent = `${done} / ${goal} pages today`;
  } catch (e) {
    $goalBarWrap.classList.add('hidden');
  }
}

// â”€â”€ ESTIMATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEstimate() {
  try {
    const raw = ($pagesLeft.value || '').trim();
    const pl = parseInt(raw, 10);

    // No valid number entered
    if (!raw || isNaN(pl) || pl <= 0) {
      $estimateResult.classList.add('hidden');
      $estimatePh.style.display = '';
      $estimatePh.textContent = 'Enter pages to estimate';
      return;
    }

    const recs = getRecords();

    // Pages entered but no history to base average on
    if (!recs.length) {
      $estimateResult.classList.add('hidden');
      $estimatePh.style.display = '';
      $estimatePh.textContent = 'â€” â€” â€” â€” â€” â€”';
      return;
    }

    // Calculate average from all valid records
    const validRecs = recs.filter(r => typeof r.ms === 'number' && r.ms > 0);
    if (!validRecs.length) {
      $estimateResult.classList.add('hidden');
      $estimatePh.style.display = '';
      $estimatePh.textContent = 'â€” â€” â€” â€” â€” â€”';
      return;
    }

    const avg = validRecs.reduce((a, r) => a + r.ms, 0) / validRecs.length;
    const remainingMs = avg * pl;
    const finishAt = new Date(Date.now() + remainingMs);

    $estimatePh.style.display = 'none';
    $estimateResult.classList.remove('hidden');
    $finishTime.textContent = `Finishes ${finishAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    $finishDur.textContent = `~${fmtDuration(remainingMs)} left`;
  } catch (e) {
    // Any unexpected error â€” reset to safe state
    $estimateResult.classList.add('hidden');
    $estimatePh.style.display = '';
    $estimatePh.textContent = 'Enter pages to estimate';
  }
}

// â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcStreak() {
  try {
    const recs = getRecords();
    if (!recs.length) return 0;
    const days = new Set(recs.map(r => {
      try { return new Date(r.ts).toDateString(); } catch { return null; }
    }).filter(Boolean));
    let streak = 0;
    const d = new Date();
    while (days.has(d.toDateString())) {
      streak++;
      d.setDate(d.getDate() - 1);
    }
    return streak;
  } catch { return 0; }
}

function renderAnalytics() {
  try {
    const recs = getRecords();

    // Streak
    const streak = calcStreak();
    if (streak > 0) {
      $streakArea.style.display = 'flex';
      $streakNum.textContent = streak;
      $streakSub.textContent = streak === 1 ? 'Day streak â€” keep going!' : `${streak} days in a row ðŸŽ¯`;
    } else {
      $streakArea.style.display = 'none';
    }

    // Grid
    if (!recs.length) {
      $analyticsGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:20px"><div class="empty-title" style="font-size:13px">No data yet</div></div>';
      $barChart.innerHTML = '<div class="empty-state" style="padding:10px;width:100%"><div class="empty-title" style="font-size:12px">No data yet</div></div>';
      return;
    }

    const total = recs.reduce((a, r) => a + (r.ms || 0), 0);
    const avg = total / recs.length;
    const best = Math.min(...recs.map(r => r.ms || Infinity));
    const todayCount = todayPages();

    $analyticsGrid.innerHTML = `
      <div class="analytics-card">
        <div class="analytics-num">${recs.length}</div>
        <div class="analytics-label">Total Pages</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-num">${todayCount}</div>
        <div class="analytics-label">Today</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-num">${best === Infinity ? 'â€”' : fmtStat(best)}</div>
        <div class="analytics-label">Best Page</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-num">${fmtStat(avg)}</div>
        <div class="analytics-label">Avg / Page</div>
      </div>`;

    // Bar chart â€” last 10 records
    const recent = recs.slice(-10);
    const maxMs = Math.max(...recent.map(r => r.ms || 0));
    const minMs = Math.min(...recent.map(r => r.ms || 0));

    if (maxMs === 0) {
      $barChart.innerHTML = '<div class="empty-state" style="padding:10px;width:100%"><div class="empty-title" style="font-size:12px">No data yet</div></div>';
      return;
    }

    $barChart.innerHTML = recent.map(r => {
      const h = Math.max((r.ms / maxMs) * 72, 4);
      const cls = r.ms === minMs ? 'bar fastest' : r.ms === maxMs ? 'bar slowest' : 'bar';
      const shortName = (r.page || '').length > 6 ? r.page.slice(0, 6) + 'â€¦' : (r.page || '?');
      return `<div class="bar-wrap">
        <div class="${cls}" style="height:${h}px" title="${r.page}: ${fmtFull(r.ms)}"></div>
        <div class="bar-label">${shortName}</div>
      </div>`;
    }).join('');
  } catch (e) {
    // Analytics crashed â€” show empty state gracefully
    $analyticsGrid.innerHTML = '';
    $barChart.innerHTML = '<div class="empty-state" style="padding:10px;width:100%"><div class="empty-title" style="font-size:12px">Unable to load analytics</div></div>';
  }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = '') {
  try {
    const t = document.createElement('div');
    t.className = 'toast' + (type ? ' pace ' + type : '');
    t.textContent = msg;
    $toastContainer.appendChild(t);
    // Remove after animation completes (toastOut at 2.5s + 0.3s = 2.8s)
    setTimeout(() => { try { t.remove(); } catch {} }, 2900);
  } catch {}
}

// â”€â”€ PACE TOASTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkPaceToast(comparison) {
  if (!comparison) return;
  try {
    const pct = parseFloat(comparison.pct);
    if (isNaN(pct)) return;
    if (comparison.faster && pct >= 30) {
      toast("Are gazab!  ðŸ˜„", 'great');
    } else if (comparison.slower && pct >= 100) {
      toast("Haramkhor! Itna time lgayega? ðŸ˜¡", 'focus');
    } else if (comparison.slower && pct >= 60) {
      toast("Kya re! kitna time lega? ", 'focus');
    }
  } catch {}
}

// â”€â”€ CELEBRATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CELEBRATIONS = [
  { emoji: 'ðŸ†', title: 'Goal Crushed!',    msg: "You hit your daily target like a champion. Your future self is proud of you right now.", btn: "Let's keep going! ðŸš€" },
  { emoji: 'ðŸŒŸ', title: 'Star Student!',    msg: "Daily goal? Done. You showed up, you focused, you delivered. That's what champions do.", btn: "I'm unstoppable! âš¡" },
  { emoji: 'ðŸ”¥', title: 'On Fire Today!',   msg: "You absolutely smashed your goal. Take a breath, then go for more â€” you've earned it!", btn: "Keep the fire burning! ðŸ”¥" },
];

const PAGES_LEFT_DONE = [
  { emoji: 'ðŸ“–', title: 'All Pages Done!',    msg: "You read everything you set out to read. Close the book and enjoy the victory â€” well earned.", btn: "That felt good! ðŸ˜Ž" },
  { emoji: 'âœ…', title: 'Reading Complete!',  msg: "Every single page â€” done. Your consistency is seriously impressive. Keep this energy!", btn: "Nailed it! ðŸ’ª" },
  { emoji: 'ðŸŽ¯', title: 'Bullseye!',          msg: "You finished every page on your list. Zero left. That discipline will take you far.", btn: "Onwards! ðŸƒ" },
];

function launchConfetti() {
  try {
    const colors = ['#7c6fa0','#4a7c59','#b45309','#be123c','#1d4ed8','#f59e0b'];
    $confettiWrap.innerHTML = '';
    for (let i = 0; i < 60; i++) {
      const el = document.createElement('div');
      el.className = 'confetti-piece';
      el.style.cssText = `
        left:${Math.random()*100}%;
        top:${-10 - Math.random()*40}px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        animation-duration:${1.2 + Math.random()*1.8}s;
        animation-delay:${Math.random()*0.5}s;
        width:${6 + Math.random()*8}px;
        height:${6 + Math.random()*8}px;
        border-radius:${Math.random()>0.5?'50%':'2px'};`;
      $confettiWrap.appendChild(el);
    }
    setTimeout(() => { try { $confettiWrap.innerHTML = ''; } catch {} }, 3500);
  } catch {}
}

function showCelebration(pool) {
  try {
    const pick = pool[Math.floor(Math.random() * pool.length)];
    $celebEmoji.textContent = pick.emoji;
    $celebTitle.textContent = pick.title;
    $celebMsg.textContent   = pick.msg;
    $celebClose.textContent = pick.btn;
    // Reset emoji animation so it plays again each time
    $celebEmoji.style.animation = 'none';
    void $celebEmoji.offsetHeight; // reflow trigger
    $celebEmoji.style.animation = '';
    $celebOverlay.classList.add('open');
    launchConfetti();
  } catch {}
}

$celebClose.addEventListener('click', () => { try { $celebOverlay.classList.remove('open'); } catch {} });
$celebOverlay.addEventListener('click', e => { if (e.target === $celebOverlay) $celebOverlay.classList.remove('open'); });

let pagesLeftCelebrated = false;

function checkRewards(prevDoneCount) {
  try {
    const book = getCurrentBook();
    const goal = (typeof book.goal === 'number' ? book.goal : 0) || (typeof settings.goal === 'number' ? settings.goal : 0);
    const done = todayPages();

    // Goal reward: fires exactly once when crossing the threshold
    if (goal > 0 && prevDoneCount < goal && done >= goal) {
      setTimeout(() => showCelebration(CELEBRATIONS), 400);
      return;
    }

    // Pages left = 0 reward
    const pl = parseInt($pagesLeft.value, 10);
    if (!isNaN(pl) && pl === 0 && !pagesLeftCelebrated) {
      pagesLeftCelebrated = true;
      setTimeout(() => showCelebration(PAGES_LEFT_DONE), 400);
    }
  } catch {}
}

// Reset pages-left celebration flag when user enters a new number
$pagesLeft.addEventListener('input', () => {
  const pl = parseInt($pagesLeft.value, 10);
  if (!isNaN(pl) && pl > 0) pagesLeftCelebrated = false;
  save('sw_pagesLeft', $pagesLeft.value);
  updateEstimate();
});

// â”€â”€ VIEW MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(mode) {
  state.viewMode = mode;
  if (mode === 'ring') {
    $timerSection.classList.add('show-ring');
    $ringModeBtn.classList.add('active');
    $flatModeBtn.classList.remove('active');
  } else {
    $timerSection.classList.remove('show-ring');
    $flatModeBtn.classList.add('active');
    $ringModeBtn.classList.remove('active');
  }
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    const tabEl = document.getElementById('tab-' + btn.dataset.tab);
    if (tabEl) tabEl.classList.add('active');
    if (btn.dataset.tab === 'analytics') renderAnalytics();
  });
});

// â”€â”€ CONFIRM MODAL (replaces native confirm()) â”€â”€â”€â”€â”€â”€
let confirmCallback = null;
function showConfirm(msg, onYes) {
  confirmCallback = onYes;
  document.getElementById('confirmMsg').textContent = msg;
  openModal('confirmModal');
}
document.getElementById('confirmYes').addEventListener('click', () => {
  closeModal('confirmModal');
  if (typeof confirmCallback === 'function') {
    try { confirmCallback(); } catch {}
  }
  confirmCallback = null;
});
document.getElementById('confirmNo').addEventListener('click', () => {
  closeModal('confirmModal');
  confirmCallback = null;
});

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('open');
}
function closeModal(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('open');
}

document.getElementById('addBookBtn').addEventListener('click', () => openModal('addBookModal'));
document.getElementById('cancelAddBook').addEventListener('click', () => closeModal('addBookModal'));
document.getElementById('confirmAddBook').addEventListener('click', () => {
  const titleEl = document.getElementById('newBookTitle');
  const goalEl  = document.getElementById('newBookGoal');
  const title = (titleEl.value || '').trim().slice(0, 50);
  if (!title) { toast('Enter a book title'); return; }
  const goal = Math.max(0, parseInt(goalEl.value, 10) || 0);
  const id = 'book_' + Date.now();
  books[id] = { title, goal, records: [] };
  saveBooks();
  state.currentBook = id;
  renderBookSelect();
  renderHistory();
  updateStats();
  updateGoalBar();
  updateEstimate(); // fresh estimate for new empty book
  closeModal('addBookModal');
  titleEl.value = '';
  goalEl.value = '';
  toast(`ðŸ“š "${title}" added`);
});

document.getElementById('settingsBtn').addEventListener('click', () => {
  document.getElementById('settingName').value = settings.name || '';
  document.getElementById('settingGoal').value = settings.goal || '';
  openModal('settingsModal');
});
document.getElementById('cancelSettings').addEventListener('click', () => closeModal('settingsModal'));
document.getElementById('saveSettings').addEventListener('click', () => {
  settings.name = (document.getElementById('settingName').value || '').trim().slice(0, 30);
  settings.goal = Math.max(0, parseInt(document.getElementById('settingGoal').value, 10) || 0);
  save('sw_settings', settings);
  closeModal('settingsModal');
  updateGoalBar();
  toast('Settings saved âœ“');
});

// Close any modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

// â”€â”€ BOOK SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$bookSelect.addEventListener('change', () => {
  const newId = $bookSelect.value;
  if (books[newId]) {
    state.currentBook = newId;
    renderHistory();
    updateStats();
    updateGoalBar();
    updateEstimate(); // recalculate for new book's records
    renderAnalytics();
  }
});

// â”€â”€ CLEAR ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$clearBtn.addEventListener('click', () => {
  showConfirm('Delete all records for this book?', () => {
    getCurrentBook().records = [];
    saveBooks();
    renderHistory();
    updateStats();
    updateGoalBar();
    renderAnalytics();
    updateEstimate();
    toast('History cleared');
  });
});

// â”€â”€ BUTTON EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$startBtn.addEventListener('click', startTimer);
$pauseBtn.addEventListener('click', pauseTimer);
$resetBtn.addEventListener('click', resetTimer);
$lapBtn.addEventListener('click', lap);
$saveBtn.addEventListener('click', saveRecord);
$pageInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); saveRecord(); } });
$flatModeBtn.addEventListener('click', () => setView('flat'));
$ringModeBtn.addEventListener('click', () => setView('ring'));
document.getElementById('statsBtn').addEventListener('click', () => {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const btn = document.querySelector('.tab-btn[data-tab="analytics"]');
  const tab = document.getElementById('tab-analytics');
  if (btn) btn.classList.add('active');
  if (tab) tab.classList.add('active');
  renderAnalytics();
});

// Prevent accidental close when timer running
window.addEventListener('beforeunload', e => {
  if (state.running) { e.preventDefault(); e.returnValue = ''; }
});

// When app comes back to foreground, resync the timer start offset
// (prevents drift if device clock changed while backgrounded)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && state.running) {
    state.startTime = Date.now() - state.elapsed;
  }
  // Also refresh estimate time display (it uses Date.now() for finish time)
  if (!document.hidden) updateEstimate();
});

// Update estimate finish time every minute (the time projection changes as clock advances)
setInterval(updateEstimate, 60000);

// â”€â”€ PWA INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  if (!load('sw_install_dismissed', false)) {
    setTimeout(() => { try { $installBanner.classList.add('show'); } catch {} }, 2000);
  }
});

$installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  try {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    $installBanner.classList.remove('show');
    if (outcome === 'accepted') toast('StudyWatch installed! ðŸŽ‰');
  } catch {}
});

$installDismiss.addEventListener('click', () => {
  $installBanner.classList.remove('show');
  save('sw_install_dismissed', true);
});

window.addEventListener('appinstalled', () => {
  try { $installBanner.classList.remove('show'); } catch {}
  toast('StudyWatch is now installed! ðŸŽ‰');
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  try {
    if ($pagesLeft && pagesLeftVal) $pagesLeft.value = pagesLeftVal;
    renderBookSelect();
    renderHistory();
    updateStats();
    updateGoalBar();
    updateEstimate();
    updateDisplay();
  } catch (e) {
    // If init crashes for any reason, at least show the UI
    console.error('Init error:', e);
  }
})();

// Service worker registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {
      // SW failed â€” app still works, just no offline support
    });
  });
}
</script>
</body>
</html>
